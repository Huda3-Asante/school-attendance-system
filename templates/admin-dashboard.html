<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/x-icon" href="/static/favicon.jpeg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="dashboard">

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo-section">
            <img src="/static/logo.jpeg" class="logo" alt="School Logo">
            <h2>New Church School</h2>
            <p class ="school-motto"><i>Discipline â€¢ Integrity â€¢ Perseverance â€¢ Service</i></p>
        </div>
        <ul>
            <li><button onclick="getSummary(); closeMenu();">Daily Summary</button></li>
            <li><button onclick="getAbsentees(); closeMenu();">Absentees</button></li>
            <li><button onclick="getAttendancePercentage(); closeMenu();">Attendance %</button></li>
            <li><button onclick="loadAllStaff(); closeMenu();">All Staff</button></li>
            <li><button onclick="logout();">Logout</button></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main">
        <button class="menu-toggle" onclick="toggleMenu()">â˜°</button>

       <h1>Admin Dashboard</h1>

<div class="analytics-cards">
    <div class="card">
        <h3>Total Staff</h3>
        <p id="totalStaff">0</p>
    </div>

    <div class="card">
        <h3>Present</h3>
        <p id="presentCount">0</p>
    </div>

    <div class="card">
        <h3>Late</h3>
        <p id="lateCount">0</p>
    </div>

    <div class="card">
        <h3>Absent</h3>
        <p id="absentCount">0</p>
    </div>
</div>

<div class="chart-container">
    <canvas id="attendanceChart"></canvas>
</div>

<div id="output" class="data-section" style="margin-top:20px;"></div>

<div id="staffSection" class="data-section" style="display:none;">
    <h2>All Staff</h2>
    <table id="staffTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

</div>

<script>
const token = localStorage.getItem("token");


if (!token) {
    globalThis.location.href = "/login-page";
}

async function getSummary() {
    const response = await fetch("/daily-summary", {
        headers: {
            "Authorization": "Bearer " + token
        }
    });

    const data = await response.json();

    document.getElementById("totalStaff").textContent = data.total_staff;
    document.getElementById("presentCount").textContent = data.present_count;
    document.getElementById("lateCount").textContent = data.late_count;
    document.getElementById("absentCount").textContent = data.absent_count;
}

async function getAbsentees() {

    const response = await fetch("/absentees", {
        headers: {
            "Authorization": "Bearer " + token
        }
    });

    const data = await response.json();

    if (response.ok) {

        const absentees = data.absentees;

        const output = document.getElementById("output");
        output.innerHTML = "";

        if (absentees.length === 0) {
            output.innerHTML = "<p>No absentees today ðŸŽ‰</p>";
            return;
        }

        absentees.forEach(user => {
            output.innerHTML += `
                <p>${user.full_name} - ${user.email}</p>
            `;
        });

    } else {
        alert(data.detail);
    }
}
function logout() {
    localStorage.clear();
    globalThis.location.href = "/login-page";
}


globalThis.addEventListener("DOMContentLoaded", loadAnalytics);

async function loadAnalytics() {
    const response = await fetch("/daily-summary", {
        headers: {
            "Authorization": "Bearer " + token
        }
    });

    const data = await response.json();

    if (response.ok) {

        document.getElementById("totalStaff").textContent = data.total_staff;
        document.getElementById("presentCount").textContent = data.present_count;
        document.getElementById("lateCount").textContent = data.late_count;
        document.getElementById("absentCount").textContent = data.absent_count;

        const ctx = document.getElementById("attendanceChart");

        new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: ["Present", "Late", "Absent"],
                datasets: [{
                    data: [
                        data.present_count,
                        data.late_count,
                        data.absent_count
                    ],
                    backgroundColor: [
                        "#16a34a",
                        "#f59e0b",
                        "#dc2626"
                    ]
                }]
            },
            responsive: true,
        maintainAspectRatio: false
        });
    }
}
async function loadAllStaff() {

    const response = await fetch("/all-staff", {
        headers: {
            "Authorization": "Bearer " + token
        }
    });

    const data = await response.json();

    if (response.ok) {

        document.getElementById("staffSection").style.display = "block";

        const tableBody = document.querySelector("#staffTable tbody");
        tableBody.innerHTML = "";

        data.forEach(user => {
            const row = `
    <tr>
        <td>${user.id}</td>
        <td>${user.full_name}</td>
        <td>${user.email}</td>
        <td>
            <button class="delete-btn" onclick="deleteStaff(${user.id})">
                Delete
            </button>
        </td>
    </tr>
`;
            tableBody.innerHTML += row;
        });
    }
}
async function deleteStaff(id) {

    if (!confirm("Are you sure you want to delete this staff?")) return;

    const response = await fetch(`/delete-staff/${id}`, {
        method: "DELETE",
        headers: {
            "Authorization": "Bearer " + token
        }
    });

    const data = await response.json();

    if (response.ok) {
        alert("Staff deleted");
        loadAllStaff(); 
    } else {
        alert(data.detail);
    }
}
async function getAttendancePercentage() {

    const response = await fetch("/attendance-percentage", {
        headers: {
            "Authorization": "Bearer " + token
        }
    });

    const data = await response.json();

    const output = document.getElementById("output");
    output.innerHTML = "";

    if (data.length === 0) {
        output.innerHTML = "<p>No data available.</p>";
        return;
    }

    let table = `
        <table class="attendance-table">
            <tr>
                <th>Name</th>
                <th>Present</th>
                <th>Late</th>
                <th>Attendance %</th>
            </tr>
    `;

    data.forEach(user => {
        table += `
            <tr>
                <td>${user.full_name}</td>
                <td>${user.present_days}</td>
                <td>${user.late_days}</td>
                <td>${user.attendance_percentage}%</td>
            </tr>
        `;
    });

    table += "</table>";

    output.innerHTML = table;
}
function toggleMenu() {
    document.querySelector('.sidebar').classList.toggle('active');
}

function closeMenu() {
    if (window.innerWidth <= 768) {
        document.querySelector('.sidebar').classList.remove('active');
    }
}
document.addEventListener("click", function(event) {
    const sidebar = document.querySelector(".sidebar");
    const toggle = document.querySelector(".menu-toggle");

    if (window.innerWidth <= 768 &&
        !sidebar.contains(event.target) &&
        !toggle.contains(event.target)) {
        sidebar.classList.remove("active");
    }
});
</script>

</body>
</html>
